# .github/workflows/run_tests.yml
name: Run all tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          web_port: ${{ vars.WEB_PORT }}
          mysql_root_password: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          mysql_database: ${{ vars.MYSQL_DATABASE }}
          jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          access_packages_pat: ${{ secrets.ACCESS_PACKAGES_PAT }}
      - name: Build services using Docker Compose
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
        run: docker compose build --progress=plain

      - name: Start the server under test
        run: |
          docker compose up -d
          docker ps

      - name: Start the app
        working-directory: ./web
        run: |
          npm run build
        env:
          PORT: ${{vars.WEB_PORT}}

      - name: Start web app
        working-directory: ./web
        run: |
          # Use vite dev with explicit port override
          npx vite dev --port ${{ vars.WEB_PORT }} --host &
          echo "Web server started in background with PID $!"

          # Wait for web server to be ready (Vite serves at /stars path)
          echo "Waiting for web server to be ready on port ${{ vars.WEB_PORT }}..."
          timeout 30 bash -c 'until curl -fsS "http://localhost:${{ vars.WEB_PORT }}/stars/" >/dev/null 2>&1; do echo "Waiting..."; sleep 1; done' || {
            echo "Web server failed to start!"
            jobs -l
            exit 1
          }
          echo "Web server is ready!"

      - name: Install Playwright browsers
        working-directory: ./python/test/e2e
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Verify service health
        env:
          PORT: ${{ vars.WEB_PORT }}
        run: |
          echo "=== Checking service health ==="
          echo "Port: $PORT"

          # Check API endpoint
          echo -e "\n1. Testing API endpoint..."
          timeout 60 bash -c 'until curl -fsS "http://localhost:'"$PORT"'/stars/api/hello" >/dev/null 2>&1; do echo "Waiting for API..."; sleep 2; done'
          echo "API Response:"
          curl -v "http://localhost:$PORT/stars/api/hello"

          # Check web frontend root
          echo -e "\n2. Testing web frontend root..."
          curl -v "http://localhost:$PORT/" 2>&1 | head -20

          # Check web frontend /stars/ path
          echo -e "\n3. Testing web frontend /stars/ path..."
          curl -v "http://localhost:$PORT/stars/" 2>&1 | head -20

          # Check dev login endpoint
          echo -e "\n4. Testing dev login endpoint..."
          curl -v "http://localhost:$PORT/stars/api/__dev_login?email=test@test.com&display_name=Test&role=admin" 2>&1 | head -30

          # Show running processes
          echo -e "\n5. Running processes:"
          ps aux | grep -E "node|npm|vite" | grep -v grep

          # Check if port is listening
          echo -e "\n6. Ports listening:"
          netstat -tlnp 2>/dev/null | grep ":$PORT" || ss -tlnp | grep ":$PORT"

      - name: Run tests with code coverage
        working-directory: ./python/test/e2e
        env:
          PORT: ${{ vars.WEB_PORT }}
          BASE_URL: http://localhost:${{ vars.WEB_PORT }}/stars
          HEADLESS: true
        run: |
          echo "=== Running E2E tests ==="
          echo "BASE_URL: $BASE_URL"
          echo "PORT: $PORT"
          echo "HEADLESS: $HEADLESS"
          behave --no-capture --format=pretty --verbose

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: python/test/e2e/screenshots/
          if-no-files-found: ignore

      - name: Show server logs on test failure
        if: failure()
        run: docker compose logs

      - name: Stop the apps
        if: always()
        run: |
          docker compose down
          kill $(lsof -t -i:${{ vars.WEB_PORT }})
